<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Simulador SBML</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- Pantalla inicial -->
<section id="hero" class="flex flex-col items-center justify-center h-screen">
  <h1 class="text-2xl font-bold mb-4">Sube tu archivo SBML</h1>
  <input id="sbmlFile" type="file" accept=".xml,.sbml" class="mb-4">
</section>

<!-- Resumen del modelo -->
<section id="summary" class="hidden flex flex-col items-center justify-center h-screen">
  <h2 class="text-xl font-semibold mb-4">Resumen del modelo</h2>
  <div id="summary-content" class="mb-4 text-gray-700"></div>
  <button id="continueBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Continuar</button>
</section>

<!-- Menú principal -->
<section id="menu" class="hidden flex flex-col items-center justify-center h-screen space-y-4">
  <h2 class="text-xl font-semibold">Selecciona una acción</h2>
  <button id="btnSim" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Simulación</button>
  <button id="btnGraph" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ver grafo</button>
</section>

<!-- Vista de simulación -->
<section id="sim-view" class="hidden p-0 w-full h-screen flex overflow-hidden">

  <!-- Panel lateral retraíble -->
  <div id="control-panel" class="w-80 bg-white shadow-lg border-r overflow-y-auto transition-transform duration-300">
    <div class="flex justify-between items-center bg-indigo-600 text-white p-4">
      <h2 class="text-lg font-semibold">Controles</h2>
      <button id="toggle-panel" class="px-2 py-1 bg-indigo-800 rounded hover:bg-indigo-700">⮜</button>
    </div>

    <!-- Controles de tiempo -->
    <div class="p-4 border-b">
      <h3 class="font-medium mb-2">Tiempo</h3>
      <label class="block text-sm font-medium">Tiempo final</label>
      <input id="t_end" type="number" value="50" min="1" class="border rounded p-1 w-full mb-2">
      <label class="block text-sm font-medium">Número de puntos</label>
      <input id="n_points" type="number" value="200" min="10" class="border rounded p-1 w-full">
    </div>

    <!-- Selector de especies -->
    <div class="p-4 border-b">
      <h3 class="font-medium mb-2">Especies</h3>
      <div id="species-container" class="grid grid-cols-1 gap-1 text-sm"></div>
    </div>

    <!-- Sliders de parámetros -->
    <div class="p-4">
      <h3 class="font-medium mb-2">Parámetros</h3>
      <div id="sliders" class="grid gap-3"></div>
    </div>
  </div>

  <!-- Contenedor de la gráfica -->
  <div class="flex-1 flex flex-col">
    <div class="flex justify-end bg-gray-100 border-b p-2">
      <button onclick="goBack()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">← Regresar</button>
    </div>
    <div id="plot" class="flex-1 bg-white"></div>
  </div>
</section>

<!-- Vista de grafo -->
<section id="graph-view" class="hidden p-4 w-full h-screen flex flex-col">
  <div class="flex justify-end mb-2">
    <button onclick="goBack()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">← Regresar</button>
  </div>
  <div id="cy" class="flex-1 border bg-white rounded"></div>
</section>

<script>
let backendUrl = "https://backend-2e5l.onrender.com"; // Cambia a tu URL real
let parameters = {};
let species = {};
let reactions = [];
let sbmlFile = null;
let selectedSpecies = [];
let simTimeout = null;

// Subida de archivo e inspección
document.getElementById("sbmlFile").addEventListener("change", async (e) => {
  sbmlFile = e.target.files[0];
  if (!sbmlFile) return;

  let formData = new FormData();
  formData.append("file", sbmlFile);

  let resp = await fetch(`${backendUrl}/inspect`, { method: "POST", body: formData });
  let data = await resp.json();

  parameters = data.parameters;
  species = data.species;
  reactions = data.reactions;
  selectedSpecies = Object.keys(species);

  let summaryHTML = `
    <p><strong>Parámetros:</strong> ${Object.keys(parameters).length}</p>
    <p><strong>Especies:</strong> ${Object.keys(species).length}</p>
    <p><strong>Reacciones:</strong> ${reactions.length}</p>
  `;
  document.getElementById("summary-content").innerHTML = summaryHTML;

  document.getElementById("hero").classList.add("hidden");
  document.getElementById("summary").classList.remove("hidden");
});

document.getElementById("continueBtn").addEventListener("click", () => {
  document.getElementById("summary").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
});

document.getElementById("btnSim").addEventListener("click", () => {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("sim-view").classList.remove("hidden");
  createSliders();
  createSpeciesSelector();
  simulate();
});

document.getElementById("btnGraph").addEventListener("click", () => {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("graph-view").classList.remove("hidden");
  drawGraph();
});

// Volver al menú
function goBack() {
  document.getElementById("sim-view").classList.add("hidden");
  document.getElementById("graph-view").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}

// Toggle del panel lateral
document.addEventListener("click", (e) => {
  if (e.target.id === "toggle-panel") {
    const panel = document.getElementById("control-panel");
    if (panel.classList.contains("-translate-x-full")) {
      panel.classList.remove("-translate-x-full");
      e.target.textContent = "⮜";
    } else {
      panel.classList.add("-translate-x-full");
      e.target.textContent = "⮞";
    }
  }
});

// Crear sliders
function createSliders() {
  const container = document.getElementById("sliders");
  container.innerHTML = "";
  Object.entries(parameters).forEach(([pid, val]) => {
    let wrapper = document.createElement("div");
    wrapper.className = "flex items-center space-x-2";

    let label = document.createElement("label");
    label.textContent = pid;
    label.className = "w-32 text-xs font-medium";

    let num = document.createElement("input");
    num.type = "number";
    num.value = val;
    num.step = "any";
    num.className = "border p-1 rounded w-20 text-xs";

    let rng = document.createElement("input");
    rng.type = "range";
    rng.min = val > 0 ? val * 0.1 : val - 1;
    rng.max = val > 0 ? val * 2 : val + 1;
    rng.step = val / 100 || 0.01;
    rng.value = val;
    rng.className = "flex-1";

    num.addEventListener("input", () => { rng.value = num.value; parameters[pid] = parseFloat(num.value); debounceSim(); });
    rng.addEventListener("input", () => { num.value = rng.value; parameters[pid] = parseFloat(rng.value); debounceSim(); });

    wrapper.appendChild(label);
    wrapper.appendChild(num);
    wrapper.appendChild(rng);
    container.appendChild(wrapper);
  });
}

// Selector de especies
function createSpeciesSelector() {
  const container = document.getElementById("species-container");
  container.innerHTML = "";
  Object.entries(species).forEach(([sid, name]) => {
    const label = document.createElement("label");
    label.className = "flex items-center space-x-2";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;
    checkbox.addEventListener("change", () => {
      if (checkbox.checked) {
        if (!selectedSpecies.includes(sid)) selectedSpecies.push(sid);
      } else {
        selectedSpecies = selectedSpecies.filter(x => x !== sid);
      }
      simulate(); 
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(name));
    container.appendChild(label);
  });
}

// Debounce
function debounceSim() {
  if (simTimeout) clearTimeout(simTimeout);
  simTimeout = setTimeout(simulate, 400);
}

// Simulación
async function simulate() {
  if (!sbmlFile) return;
  let t_end = parseFloat(document.getElementById("t_end").value) || 50;
  let n_points = parseInt(document.getElementById("n_points").value) || 200;

  let formData = new FormData();
  formData.append("file", sbmlFile);
  formData.append("t_start", 0);
  formData.append("t_end", t_end);
  formData.append("n_points", n_points);
  formData.append("param_values_json", JSON.stringify(parameters));
  formData.append("selected_species", selectedSpecies.join(","));

  let resp = await fetch(`${backendUrl}/simulate`, { method: "POST", body: formData });
  let data = await resp.json();
  if (data.error) { alert("Error: " + data.error); return; }

  let time = data.data.map(row => row[0]);
  let traces = [];

  for (let j = 1; j < data.columns.length; j++) {
    let sid = data.columns[j];
    let y = data.data.map(row => row[j]);
    let name = species[sid] || sid;
    traces.push({ x: time, y: y, mode: "lines", name: name });
  }
  Plotly.newPlot("plot", traces, { 
    margin: { t: 20 }, 
    xaxis: { title: "Tiempo" }, 
    yaxis: { title: "Concentración" }, 
    height: window.innerHeight - 50 
  });
}

// Grafo
function drawGraph() {
  if (!reactions.length) return;
  let elements = [];
  Object.entries(species).forEach(([sid, name]) => { elements.push({ data: { id: sid, label: name } }); });
  reactions.forEach(r => {
    r.reactants.forEach(react => { elements.push({ data: { source: react, target: r.id } }); });
    r.products.forEach(prod => { elements.push({ data: { source: r.id, target: prod } }); });
    elements.push({ data: { id: r.id, label: r.id }, classes: "reaction" });
  });
  cytoscape({
    container: document.getElementById("cy"),
    elements: elements,
    style: [
      { selector: "node", style: { "label": "data(label)", "text-valign": "center", "color": "#fff",
        "background-color": "#4f46e5", "text-outline-color": "#4f46e5", "text-outline-width": 2 } },
      { selector: "node.reaction", style: { "shape": "rectangle", "background-color": "#f59e0b",
        "text-outline-color": "#f59e0b", "color": "#000" } },
      { selector: "edge", style: { "width": 2, "line-color": "#9ca3af", "target-arrow-color": "#9ca3af",
        "target-arrow-shape": "triangle" } }
    ],
    layout: { name: "breadthfirst", directed: true, padding: 10 }
  });
}
</script>
</body>
</html>





