<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Simulador SBML</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .slider-container { margin: 10px 0; }
    .slider-label { margin-right: 10px; }
    .param-input { width: 80px; }
  </style>
</head>
<body>
  <h1>Simulador SBML</h1>

  <input type="file" id="sbmlFile" accept=".xml,.sbml" />
  <button id="inspectBtn">Cargar modelo</button>

  <div id="sliders"></div>

  <div>
    <label>Tiempo inicial: <input id="tStart" type="number" value="0"></label>
    <label>Tiempo final: <input id="tEnd" type="number" value="50"></label>
    <label>Puntos: <input id="nPoints" type="number" value="200"></label>
  </div>

  <div id="plot"></div>

  <script>
    // 🔹 URL de tu backend en Render
    const API = "https://tu-backend.onrender.com";

    let currentFile = null;
    let parameters = {};
    let species = [];
    let simulateTimeout = null;

    document.getElementById("inspectBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("sbmlFile");
      if (!fileInput.files.length) {
        alert("Sube un archivo SBML primero.");
        return;
      }
      currentFile = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", currentFile);

      const resp = await fetch(`${API}/inspect`, { method: "POST", body: formData });
      const data = await resp.json();
      parameters = data.parameters;
      species = data.species;

      renderSliders();
      simulate(); // correr la primera simulación
    });

    function renderSliders() {
      const container = document.getElementById("sliders");
      container.innerHTML = "";
      Object.keys(parameters).forEach(pid => {
        const val = parameters[pid];

        const div = document.createElement("div");
        div.className = "slider-container";

        const label = document.createElement("span");
        label.className = "slider-label";
        label.textContent = pid;

        const rng = document.createElement("input");
        rng.type = "range";
        rng.min = val * 0.1 || 0;
        rng.max = val * 10 + 1;
        rng.step = val / 50 || 0.1;
        rng.value = val;

        const num = document.createElement("input");
        num.type = "number";
        num.className = "param-input";
        num.value = val;

        // Eventos sincronizados + simulación con debounce
        const updateAndSimulate = (newVal) => {
          parameters[pid] = parseFloat(newVal);
          rng.value = newVal;
          num.value = newVal;
          triggerSimulate();
        };

        rng.addEventListener("input", () => updateAndSimulate(rng.value));
        num.addEventListener("input", () => updateAndSimulate(num.value));

        div.appendChild(label);
        div.appendChild(rng);
        div.appendChild(num);
        container.appendChild(div);
      });
    }

    // 🔹 Debounce: esperar 500 ms tras mover slider antes de simular
    function triggerSimulate() {
      if (simulateTimeout) clearTimeout(simulateTimeout);
      simulateTimeout = setTimeout(simulate, 500);
    }

    async function simulate() {
      if (!currentFile) return;

      const tStart = parseFloat(document.getElementById("tStart").value);
      const tEnd = parseFloat(document.getElementById("tEnd").value);
      const nPoints = parseInt(document.getElementById("nPoints").value);

      const formData = new FormData();
      formData.append("file", currentFile);
      formData.append("t_start", tStart);
      formData.append("t_end", tEnd);
      formData.append("n_points", nPoints);
      formData.append("selected_species", Object.keys(species).join(","));
      formData.append("param_values_json", JSON.stringify(parameters));

      const resp = await fetch(`${API}/simulate`, { method: "POST", body: formData });
      const data = await resp.json();

      if (data.error) {
        alert("Error en simulación: " + data.error);
        return;
      }

      const timeIdx = data.columns.indexOf("time");
      const traces = [];
      data.columns.forEach((col, i) => {
        if (col === "time") return;
        traces.push({
          x: data.data.map(row => row[timeIdx]),
          y: data.data.map(row => row[i]),
          mode: "lines",
          name: col
        });
      });

      Plotly.newPlot("plot", traces, { title: "Simulación SBML" });
    }
  </script>
</body>
</html>

