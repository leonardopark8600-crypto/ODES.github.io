<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Simulador SBML</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 2s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

  <!-- Hero -->
  <section id="hero" class="flex-1 flex flex-col justify-center items-center text-center">
    <h1 class="text-5xl md:text-6xl font-bold text-indigo-600 fade-in">Simulador de SBML</h1>
    <p class="mt-4 text-lg text-gray-500 fade-in">Sube un archivo SBML para comenzar</p>
    <input id="sbmlFile" type="file" accept=".xml,.sbml" 
           class="mt-8 px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg shadow hover:bg-indigo-700 transition cursor-pointer fade-in">
  </section>

  <!-- Paso 2: Resumen -->
  <section id="summary" class="hidden p-6 max-w-3xl mx-auto text-center fade-in">
    <h2 class="text-2xl font-semibold mb-4">Resumen del modelo</h2>
    <div id="summary-content" class="bg-white shadow rounded-lg p-4 text-left"></div>
    <button id="continueBtn" 
            class="mt-6 px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg shadow hover:bg-indigo-700 transition">
      Continuar
    </button>
  </section>

  <!-- Paso 3: Menú -->
  <section id="menu" class="hidden p-6 text-center fade-in">
    <h2 class="text-2xl font-semibold mb-6">¿Qué deseas hacer?</h2>
    <div class="flex justify-center gap-6">
      <button id="btnSim" class="px-6 py-3 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition">
        Simulación
      </button>
      <button id="btnGraph" class="px-6 py-3 bg-yellow-500 text-white rounded-lg shadow hover:bg-yellow-600 transition">
        Diagrama
      </button>
    </div>
  </section>

  <!-- Simulación -->
  <section id="sim-view" class="hidden p-6 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Simulación</h2>
      <button onclick="goBack()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">← Regresar</button>
    </div>

    <!-- Controles de tiempo -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium">Tiempo final</label>
        <input id="t_end" type="number" value="50" min="1" class="border rounded p-1 w-full">
      </div>
      <div>
        <label class="block text-sm font-medium">Número de puntos</label>
        <input id="n_points" type="number" value="200" min="10" class="border rounded p-1 w-full">
      </div>
    </div>

    <!-- Sliders -->
    <div id="sliders" class="grid gap-4 mb-6"></div>

    <!-- Gráfica -->
    <div id="plot" class="w-full h-[600px] bg-white rounded shadow p-4"></div>
  </section>

  <!-- Diagrama -->
  <section id="graph-view" class="hidden p-6 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Diagrama de la red</h2>
      <button onclick="goBack()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">← Regresar</button>
    </div>
    <div id="cy" class="w-full h-[700px] bg-white rounded shadow"></div>
  </section>

<script>
let backendUrl = "https://backend-2e5l.onrender.com"; // <--- cambia
let parameters = {};
let species = {};
let reactions = [];
let sbmlFile = null;

// File upload → inspección
document.getElementById("sbmlFile").addEventListener("change", async (e) => {
  sbmlFile = e.target.files[0];
  if (!sbmlFile) return;

  let formData = new FormData();
  formData.append("file", sbmlFile);

  let resp = await fetch(`${backendUrl}/inspect`, { method: "POST", body: formData });
  let data = await resp.json();

  parameters = data.parameters;
  species = data.species;
  reactions = data.reactions;

  let summaryHTML = `
    <p><strong>Parámetros:</strong> ${Object.keys(parameters).length}</p>
    <p><strong>Especies:</strong> ${Object.keys(species).length}</p>
    <p><strong>Reacciones:</strong> ${reactions.length}</p>
  `;
  document.getElementById("summary-content").innerHTML = summaryHTML;

  document.getElementById("hero").classList.add("hidden");
  document.getElementById("summary").classList.remove("hidden");
});

// Continue button
document.getElementById("continueBtn").addEventListener("click", () => {
  document.getElementById("summary").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
});

// Menu buttons
document.getElementById("btnSim").addEventListener("click", () => {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("sim-view").classList.remove("hidden");
  createSliders();
  simulate();
});

document.getElementById("btnGraph").addEventListener("click", () => {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("graph-view").classList.remove("hidden");
  drawGraph();
});

// Volver al menú
function goBack() {
  document.getElementById("sim-view").classList.add("hidden");
  document.getElementById("graph-view").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}

// Sliders
function createSliders() {
  const container = document.getElementById("sliders");
  container.innerHTML = "";
  Object.entries(parameters).forEach(([pid, val]) => {
    let wrapper = document.createElement("div");
    wrapper.className = "flex items-center space-x-2";

    let label = document.createElement("label");
    label.textContent = pid;
    label.className = "w-40 text-sm font-medium";

    let num = document.createElement("input");
    num.type = "number";
    num.value = val;
    num.step = "any";
    num.className = "border p-1 rounded w-24";

    let rng = document.createElement("input");
    rng.type = "range";
    rng.min = val * 0.1;
    rng.max = val * 2;
    rng.step = val / 100 || 0.01;
    rng.value = val;
    rng.className = "flex-1";

    num.addEventListener("input", () => { rng.value = num.value; parameters[pid] = parseFloat(num.value); debounceSim(); });
    rng.addEventListener("input", () => { num.value = rng.value; parameters[pid] = parseFloat(rng.value); debounceSim(); });

    wrapper.appendChild(label);
    wrapper.appendChild(num);
    wrapper.appendChild(rng);
    container.appendChild(wrapper);
  });
}

// Debounce
let simTimeout = null;
function debounceSim() {
  if (simTimeout) clearTimeout(simTimeout);
  simTimeout = setTimeout(simulate, 400);
}

// Simulación
async function simulate() {
  if (!sbmlFile) return;
  let t_end = parseFloat(document.getElementById("t_end").value) || 50;
  let n_points = parseInt(document.getElementById("n_points").value) || 200;

  let formData = new FormData();
  formData.append("file", sbmlFile);
  formData.append("t_start", 0);
  formData.append("t_end", t_end);
  formData.append("n_points", n_points);
  formData.append("param_values_json", JSON.stringify(parameters));
  formData.append("selected_species", Object.keys(species).join(","));

  let resp = await fetch(`${backendUrl}/simulate`, { method: "POST", body: formData });
  let data = await resp.json();
  if (data.error) { alert("Error: " + data.error); return; }

  let time = data.data.map(row => row[0]);
  let traces = [];
  for (let j = 1; j < data.columns.length; j++) {
    let y = data.data.map(row => row[j]);
    traces.push({ x: time, y: y, mode: "lines", name: data.columns[j] });
  }
  Plotly.newPlot("plot", traces, { 
    margin: { t: 20 }, 
    xaxis: { title: "Tiempo" }, 
    yaxis: { title: "Concentración" }, 
    height: 600 
  });
}

// Grafo
function drawGraph() {
  if (!reactions.length) return;
  let elements = [];
  Object.keys(species).forEach(sid => { elements.push({ data: { id: sid, label: species[sid] } }); });
  reactions.forEach(r => {
    r.reactants.forEach(react => { elements.push({ data: { source: react, target: r.id } }); });
    r.products.forEach(prod => { elements.push({ data: { source: r.id, target: prod } }); });
    elements.push({ data: { id: r.id, label: r.id }, classes: "reaction" });
  });
  cytoscape({
    container: document.getElementById("cy"),
    elements: elements,
    style: [
      { selector: "node", style: { "label": "data(label)", "text-valign": "center", "color": "#fff",
        "background-color": "#4f46e5", "text-outline-color": "#4f46e5", "text-outline-width": 2 } },
      { selector: "node.reaction", style: { "shape": "rectangle", "background-color": "#f59e0b",
        "text-outline-color": "#f59e0b", "color": "#000" } },
      { selector: "edge", style: { "width": 2, "line-color": "#9ca3af", "target-arrow-color": "#9ca3af",
        "target-arrow-shape": "triangle" } }
    ],
    layout: { name: "cose" }
  });
}
</script>
</body>
</html>




